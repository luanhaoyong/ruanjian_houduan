<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ·»åŠ è½¯ä»¶ - ç®¡ç†å‘˜åå°</title>
  <link rel="stylesheet" href="admin-add.css">
</head>
<body>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">æç¤º</h3>
      <button onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalContent"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-primary" id="modalConfirmBtn">ç¡®å®š</button>
    </div>
  </div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="logo">
      <h2>è½¯ä»¶ç®¡ç†åå°</h2>
    </div>
    <a href="admin-list.html" class="nav-item">ğŸ“‹ è½¯ä»¶åˆ—è¡¨</a>
    <a href="admin-add.html" class="nav-item active">â• æ·»åŠ è½¯ä»¶</a>
  </div>

  <div class="main-content">
    <div class="header">
      <h1>æ·»åŠ æ–°è½¯ä»¶</h1>
      <div class="user-wrap">
        <span id="username">åŠ è½½ä¸­...</span>
        <button class="logout-btn" onclick="logout()">é€€å‡º</button>
      </div>
    </div>

    <div class="form-box">
      <div class="form-group">
        <label>è½¯ä»¶åç§° *</label>
        <input id="name" placeholder="å¿…å¡«">
      </div>
      <div class="form-group">
        <label>ç‰ˆæœ¬å· *</label>
        <input id="version" placeholder="å¿…å¡«">
      </div>
      <div class="form-group">
        <label>å¼€å‘è€…</label>
        <input id="author" placeholder="é€‰å¡«">
      </div>
      <div class="form-group">
        <label>æè¿°</label>
        <textarea id="desc" rows="3" placeholder="é€‰å¡«"></textarea>
      </div>
      <div class="form-group">
        <label>ä¸Šä¼ å®‰è£…åŒ…</label>
        <input type="file" id="file">
      </div>
      <button class="submit-btn" onclick="addSoftware()">æäº¤ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  let modalCallback = null;

  function openModal(title, content, confirmText = "ç¡®å®š", cancelText = "å–æ¶ˆ", callback = null) {
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalContent').innerHTML = content.replace(/\n/g, '<br>');
    document.getElementById('modalConfirmBtn').textContent = confirmText;
    modalCallback = callback;
    document.getElementById('modalConfirmBtn').onclick = () => {
      if (modalCallback) modalCallback();
      closeModal();
    };
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    modalCallback = null;
  }

  async function init() {
    try {
      const r = await fetch('/api/user/info');
      const d = await r.json();
      if (d.code === -2) {
        openModal('è¯·ç™»å½•', '', 'ç¡®å®š', 'å–æ¶ˆ', () => location.href = 'index.html');
        return;
      }
      if (d.data.role !== 'admin') {
        openModal('æ— æƒé™', 'ä»…ç®¡ç†å‘˜å¯è®¿é—®', 'ç¡®å®š', 'å–æ¶ˆ', () => location.href = 'user-index.html');
        return;
      }
      document.getElementById('username').textContent = `ç®¡ç†å‘˜ï¼š${d.data.username}`;
    } catch (e) {
      openModal('é”™è¯¯', 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'ç¡®å®š');
    }
  }

  async function addSoftware() {
    const name = document.getElementById('name').value.trim();
    const version = document.getElementById('version').value.trim();
    if (!name || !version) {
      openModal('æç¤º', 'åç§°å’Œç‰ˆæœ¬å¿…å¡«');
      return;
    }
    const fd = new FormData();
    fd.append('name', name);
    fd.append('version', version);
    fd.append('author', document.getElementById('author').value);
    fd.append('desc', document.getElementById('desc').value);
    const file = document.getElementById('file').files[0];
    if (file) fd.append('file', file);

    try {
      const r = await fetch('/api/software', { method: 'POST', body: fd });
      const d = await r.json();
      if (d.code === 0) {
        openModal('æˆåŠŸ', 'æ·»åŠ æˆåŠŸ', 'ç¡®å®š', 'å–æ¶ˆ', () => {
          document.getElementById('name').value = '';
          document.getElementById('version').value = '';
          document.getElementById('author').value = '';
          document.getElementById('desc').value = '';
          document.getElementById('file').value = '';
        });
      } else {
        openModal('å¤±è´¥', d.msg || 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (e) {
      openModal('é”™è¯¯', 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æœåŠ¡åé‡è¯•', 'ç¡®å®š');
    }
  }

  async function logout() {
    openModal('é€€å‡º', 'ç¡®å®šé€€å‡ºï¼Ÿ', 'é€€å‡º', 'å–æ¶ˆ', async () => {
      try {
        await fetch('/api/logout', { method: 'POST' });
        location.href = 'index.html';
      } catch (e) {
        openModal('é”™è¯¯', 'é€€å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'ç¡®å®š');
      }
    });
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  window.onload = init;
</script>
</body>
</html>