<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è½¯ä»¶åˆ—è¡¨ - ç®¡ç†å‘˜åå°</title>
  <link rel="stylesheet" href="admin-list.css">
</head>
<body>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">æç¤º</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalContent"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-primary" id="modalConfirmBtn">ç¡®å®š</button>
    </div>
  </div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="logo">
      <h2>è½¯ä»¶ç®¡ç†åå°</h2>
    </div>
    <a href="admin-list.html" class="nav-item active">ğŸ“‹ è½¯ä»¶åˆ—è¡¨</a>
    <a href="admin-add.html" class="nav-item">â• æ·»åŠ è½¯ä»¶</a>
  </div>

  <div class="main-content">
    <div class="header">
      <h1>è½¯ä»¶åˆ—è¡¨ç®¡ç†</h1>
      <div class="user-info">
        <span id="username">åŠ è½½ä¸­...</span>
        <button class="btn-danger" onclick="logout()">é€€å‡º</button>
      </div>
    </div>

    <div class="search-box">
      <input id="keyword" placeholder="æœç´¢è½¯ä»¶" oninput="loadList()">
      <button class="btn-primary" onclick="loadList()">æœç´¢</button>
    </div>

    <div class="table-box">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>åç§°</th>
            <th>ç‰ˆæœ¬</th>
            <th>å¼€å‘è€…</th>
            <th>æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  let page = 1;
  const limit = 10;
  let modalCallback = null;

  function openModal(title, content, confirmText = "ç¡®å®š", cancelText = "å–æ¶ˆ", callback = null) {
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalContent').innerHTML = content.replace(/\n/g, '<br>');
    document.getElementById('modalConfirmBtn').textContent = confirmText;
    document.querySelector('.modal-footer .btn-secondary').textContent = cancelText;
    modalCallback = callback;
    document.getElementById('modalConfirmBtn').onclick = () => {
      if (modalCallback) modalCallback();
      closeModal();
    };
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
    modalCallback = null;
  }

  async function init() {
    try {
      const res = await fetch('/api/user/info');
      const data = await res.json();
      if (data.code === -2) {
        openModal('è¯·å…ˆç™»å½•', '', 'ç¡®å®š', 'å–æ¶ˆ', () => location.href = 'index.html');
        return;
      }
      if (data.data.role !== 'admin') {
        openModal('æ— æƒé™', 'ä»…ç®¡ç†å‘˜å¯è®¿é—®', 'ç¡®å®š', 'å–æ¶ˆ', () => location.href = 'user-index.html');
        return;
      }
      document.getElementById('username').textContent = `ç®¡ç†å‘˜ï¼š${data.data.username}`;
      loadList();
    } catch (e) {
      openModal('é”™è¯¯', 'åŠ è½½å¤±è´¥', 'ç¡®å®š');
    }
  }

  async function loadList() {
    const keyword = document.getElementById('keyword').value.trim();
    const r = await fetch(`/api/software?page=${page}&limit=${limit}&keyword=${keyword}`);
    const d = await r.json();
    const list = document.getElementById('list');
    list.innerHTML = '';
    if (!d.data || d.data.length === 0) {
      list.innerHTML = '<tr><td colspan="7" align="center">æš‚æ— æ•°æ®</td></tr>';
      return;
    }
    d.data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>${item.version}</td>
        <td>${item.author || '-'}</td>
        <td>${item.createTime}</td>
        <td>
          <label class="switch">
            <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleSoftware(${item.id}, this.checked)">
            <span class="slider"></span>
          </label>
        </td>
        <td>
          <button class="btn-danger" onclick="confirmDelete(${item.id})">åˆ é™¤</button>
          <button class="btn-success" onclick="copyPermissionUrl(${item.id}, this)">å¤åˆ¶æƒé™æ¥å£</button>
        </td>
      `;
      list.appendChild(tr);
    });
  }

  function confirmDelete(id) {
    openModal('ç¡®è®¤åˆ é™¤', 'ç¡®å®šåˆ é™¤ï¼Ÿ', 'åˆ é™¤', 'å–æ¶ˆ', () => delSoftware(id));
  }

  async function delSoftware(id) {
    const r = await fetch(`/api/software/${id}`, { method: 'DELETE' });
    const d = await r.json();
    if (d.code === 0) {
      openModal('æˆåŠŸ', 'åˆ é™¤æˆåŠŸ', 'ç¡®å®š', 'å–æ¶ˆ', loadList);
    } else {
      openModal('å¤±è´¥', d.msg);
    }
  }

  async function toggleSoftware(id, enabled) {
    const r = await fetch(`/api/software/${id}/toggle`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled })
    });
    const d = await r.json();
    if (d.code === 0) loadList();
  }

  // å¤åˆ¶æƒé™æ¥å£åœ°å€ï¼ˆå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼Œæ— å¼¹çª—ï¼ŒæŒ‰é’®æ–‡å­—åé¦ˆï¼‰
    function copyPermissionUrl(id, btnEl) {
  const protocol = window.location.protocol;
  const host = window.location.host;
  const url = `${protocol}//${host}/api/software/${id}/permission`;

  // è·å–ç‚¹å‡»çš„æŒ‰é’®å…ƒç´ ï¼ˆç”¨äºæ˜¾ç¤ºåé¦ˆï¼‰
  const btn = btnEl || event.target;
  
  // ä¼˜å…ˆä½¿ç”¨ Clipboard APIï¼Œå¤±è´¥åˆ™é™çº§åˆ° textarea æ–¹å¼
  if (navigator.clipboard && navigator.clipboard.writeText) {
    // ç§»åŠ¨ç«¯éœ€è¦åœ¨ç”¨æˆ·äº¤äº’çš„åŒæ­¥ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
    navigator.clipboard.writeText(url).then(() => {
      // æŒ‰é’®æ–‡å­—åé¦ˆï¼Œæ— å¼¹çª—
      showCopySuccess(btn);
    }).catch((err) => {
      console.error('Clipboard API å¤±è´¥:', err);
      fallbackCopy(url, btn);
    });
  } else {
    fallbackCopy(url, btn);
  }
}

// é™çº§æ–¹æ¡ˆï¼šç”¨ textarea å®ç°å¤åˆ¶ï¼ˆæ— å¼¹çª—ï¼‰
function fallbackCopy(text, btn) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  // ç§»åŠ¨ç«¯éœ€è¦è®¾ç½®ä¸ºä¸å¯è§ä½†å¯ç¼–è¾‘
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  textarea.style.left = '-9999px';
  textarea.style.top = '-9999px';
  document.body.appendChild(textarea);
  textarea.select();
  // ç§»åŠ¨ç«¯éœ€è¦è®¾ç½®é€‰ä¸­èŒƒå›´
  textarea.setSelectionRange(0, textarea.value.length);
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopySuccess(btn);
    } else {
      throw new Error('å¤åˆ¶å¤±è´¥');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    // å¤åˆ¶å¤±è´¥æ—¶ä»…ç”¨åŸç”Ÿ alert æç¤ºï¼ˆæœ€ç®€æç¤ºï¼‰
    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + text);
  }
  document.body.removeChild(textarea);
}

// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æŒ‰é’®åé¦ˆ
function showCopySuccess(btn) {
  const originalText = btn.textContent;
  btn.textContent = 'å·²å¤åˆ¶';
  btn.classList.add('copied');
  
  // 2ç§’åæ¢å¤åŸçŠ¶æ€
  setTimeout(() => {
    btn.textContent = originalText;
    btn.classList.remove('copied');
  }, 2000);
}

  async function logout() {
    openModal('é€€å‡º', 'ç¡®å®šé€€å‡ºï¼Ÿ', 'é€€å‡º', 'å–æ¶ˆ', async () => {
      await fetch('/api/logout', { method: 'POST' });
      location.href = 'index.html';
    });
  }

  init();
</script>
</body>
</html>