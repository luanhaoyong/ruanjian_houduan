<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¸­å¿ƒ - è½¯ä»¶ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- åŠ¨æ€å¼¹çª— -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">æç¤º</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalContent">
        è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€å¼¹çª—ç¤ºä¾‹
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="closeModal()" id="modalConfirmBtn">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯+é€€å‡ºæŒ‰é’® -->
    <div class="header">
      <h1>ä¸ªäººä¸­å¿ƒ</h1>
      <div class="user-info">
        <span id="username">åŠ è½½ä¸­...</span>
        <button class="btn-danger logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- æ™®é€šç”¨æˆ·ä¸“å±å†…å®¹ -->
    <div class="user-dashboard">
      <div class="card">
        <h3>æ¬¢è¿ä½¿ç”¨è½¯ä»¶ç®¡ç†ç³»ç»Ÿ</h3>
        <p>ä½ å½“å‰çš„è´¦å·ç±»å‹ï¼š<span class="role-tag">æ™®é€šç”¨æˆ·</span></p>
        <p>ä½ çš„æƒé™ï¼šå¯æŸ¥çœ‹è½¯ä»¶è¿è¡Œæƒé™çŠ¶æ€ï¼Œæ— ç®¡ç†æ“ä½œæƒé™</p>
      </div>

      <div class="card">
        <h3>è½¯ä»¶æƒé™æŸ¥è¯¢</h3>
        <p style="color: var(--gray-600); margin-bottom: 15px;">æ”¯æŒè¾“å…¥è½¯ä»¶IDï¼ˆç²¾ç¡®ï¼‰æˆ–è½¯ä»¶åç§°ï¼ˆæ¨¡ç³Šï¼‰æŸ¥è¯¢ï¼ŒæŒ‰å›è½¦é”®å¿«é€ŸæŸ¥è¯¢</p>
        <div class="form-group">
          <input id="keyword" placeholder="è¯·è¾“å…¥è½¯ä»¶IDæˆ–åç§°æŸ¥è¯¢æƒé™">
        </div>
        <button class="btn-primary" id="queryBtn">æŸ¥è¯¢æƒé™</button>
        <div id="permissionResult" class="result-box"></div>
      </div>

      <div class="card">
        <h3>ä½¿ç”¨è¯´æ˜</h3>
        <ul>
          <li>å¦‚éœ€æ·»åŠ /ä¿®æ”¹/åˆ é™¤è½¯ä»¶ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</li>
          <li>æ”¯æŒæŒ‰è½¯ä»¶IDï¼ˆç²¾ç¡®ï¼‰æˆ–åç§°ï¼ˆæ¨¡ç³Šï¼‰æŸ¥è¯¢</li>
          <li>æŸ¥è¯¢ç»“æœä»…å±•ç¤ºè½¯ä»¶æ˜¯å¦å¯è¿è¡Œï¼Œæ— ä¿®æ”¹æƒé™</li>
          <li>è¾“å…¥å®ŒæˆåæŒ‰å›è½¦é”®å¯å¿«é€Ÿè§¦å‘æŸ¥è¯¢</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let modalCallback = null;

    // å¼¹çª—æ§åˆ¶å‡½æ•°
    function openModal(title, content, confirmText = "ç¡®å®š", cancelText = "å–æ¶ˆ", callback = null) {
      const modalOverlay = document.getElementById('modalOverlay');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      const modalConfirmBtn = document.getElementById('modalConfirmBtn');
      
      modalTitle.textContent = title;
      modalContent.textContent = content;
      modalConfirmBtn.textContent = confirmText;
      document.querySelector('.modal-footer .btn-secondary').textContent = cancelText;
      
      modalCallback = callback;
      modalConfirmBtn.onclick = function() {
        if (modalCallback) modalCallback();
        closeModal();
      };
      
      modalOverlay.classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      modalCallback = null;
    }

    // åˆå§‹åŒ–ï¼šæ ¡éªŒç™»å½•æ€
    async function init() {
      try {
        const res = await fetch('/api/user/info');
        const data = await res.json();
        
        // æœªç™»å½•
        if (data.code === -2) {
          openModal('æç¤º', 'è¯·å…ˆç™»å½•ï¼', 'ç¡®å®š', 'å–æ¶ˆ', () => {
            location.href = 'index.html';
          });
          return;
        }

        // ç®¡ç†å‘˜è·³è½¬åˆ°ç®¡ç†å‘˜åå°
        if (data.data.role === 'admin') {
          openModal('æç¤º', 'ä½ æ˜¯ç®¡ç†å‘˜ï¼Œå³å°†è·³è½¬åˆ°ç®¡ç†åå°', 'ç¡®å®š', 'å–æ¶ˆ', () => {
            location.href = 'admin.html';
          });
          return;
        }

        // æ™®é€šç”¨æˆ·æ­£å¸¸åŠ è½½
        document.getElementById('username').textContent = `å½“å‰ç™»å½•ï¼š${data.data.username}`;
        
        // ç»‘å®šå›è½¦æŸ¥è¯¢äº‹ä»¶
        const keywordInput = document.getElementById('keyword');
        const queryBtn = document.getElementById('queryBtn');
        
        keywordInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            checkSoftwarePermission();
          }
        });

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        queryBtn.addEventListener('click', checkSoftwarePermission);
      } catch (err) {
        openModal('é”™è¯¯', 'ç™»å½•æ€æ ¡éªŒå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•ï¼', 'ç¡®å®š', 'å–æ¶ˆ', () => {
          location.href = 'index.html';
        });
      }
    }

    // ä¼˜åŒ–åçš„æŸ¥è¯¢å‡½æ•°ï¼šæ”¯æŒID/åç§° + å›è½¦è§¦å‘
    async function checkSoftwarePermission() {
      const keyword = document.getElementById('keyword').value.trim();
      const resultEl = document.getElementById('permissionResult');
      
      if (!keyword) {
        openModal('æç¤º', 'è¯·è¾“å…¥è½¯ä»¶IDæˆ–åç§°ï¼', 'ç¡®å®š', 'å–æ¶ˆ');
        return;
      }

      try {
        resultEl.innerHTML = '<p class="loading">æŸ¥è¯¢ä¸­...</p>';
        const res = await fetch(`/api/software/query?keyword=${encodeURIComponent(keyword)}`);
        const data = await res.json();
        
        if (data.code === 0) {
          if (data.data.list.length === 0) {
            resultEl.innerHTML = `<p class="error">âŒ ${data.data.msg}</p>`;
            openModal('æŸ¥è¯¢ç»“æœ', data.data.msg, 'ç¡®å®š', 'å–æ¶ˆ');
            return;
          }

          // æ¸²æŸ“å¤šä¸ªç»“æœï¼ˆæ·»åŠ å®Œæ•´æƒé™æ¥å£åœ°å€ï¼‰
          let html = `<p class="success">âœ… ${data.data.msg}</p>`;
          // è·å–å®Œæ•´åŸŸå+ç«¯å£
          const protocol = window.location.protocol;
          const host = window.location.host;
          
          data.data.list.forEach(item => {
            // å®Œæ•´æƒé™æ¥å£åœ°å€
            const permissionUrl = `${protocol}//${host}/api/software/${item.id}/permission`;
            html += `
              <div class="software-item">
                <h4>${item.name} (v${item.version})</h4>
                <p>è½¯ä»¶IDï¼š${item.id}</p>
                <p>è¿è¡ŒçŠ¶æ€ï¼š${item.canRun ? 'ğŸŸ¢ å¯è¿è¡Œ' : 'ğŸ”´ å·²ç¦ç”¨'}</p>
                <p>åŸå› ï¼š${item.reason}</p>
                <p>æƒé™æ¥å£ï¼š<code>${permissionUrl}</code></p>
              </div>
            `;
          });
          resultEl.innerHTML = html;
          openModal('æŸ¥è¯¢æˆåŠŸ', data.data.msg, 'ç¡®å®š', 'å–æ¶ˆ');
        } else {
          resultEl.innerHTML = `<p class="error">âŒ ${data.msg}</p>`;
          openModal('æŸ¥è¯¢å¤±è´¥', data.msg, 'ç¡®å®š', 'å–æ¶ˆ');
        }
      } catch (err) {
        resultEl.innerHTML = '<p class="error">âŒ æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜</p>';
        openModal('æŸ¥è¯¢é”™è¯¯', 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜', 'ç¡®å®š', 'å–æ¶ˆ');
        console.error(err);
      }
    }

    // é€€å‡ºç™»å½•
    async function logout() {
      openModal('ç¡®è®¤é€€å‡º', 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'ç¡®è®¤é€€å‡º', 'å–æ¶ˆ', async () => {
        try {
          const res = await fetch('/api/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await res.json();
          if (data.code === 0) {
            openModal('é€€å‡ºæˆåŠŸ', 'å·²æˆåŠŸé€€å‡ºç™»å½•ï¼', 'ç¡®å®š', 'å–æ¶ˆ', () => {
              location.href = 'index.html';
            });
          } else {
            openModal('é€€å‡ºå¤±è´¥', 'é€€å‡ºå¤±è´¥ï¼š' + data.msg, 'ç¡®å®š', 'å–æ¶ˆ');
          }
        } catch (err) {
          openModal('é€€å‡ºå¤±è´¥', 'é€€å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼', 'ç¡®å®š', 'å–æ¶ˆ');
          console.error(err);
        }
      });
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>